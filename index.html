<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Merkle Airdrop DApp</title>
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
  <!-- WalletConnect Provider -->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800 p-6">
  <div class="max-w-xl mx-auto bg-white shadow-lg rounded-2xl p-6">
    <h1 class="text-2xl font-bold mb-4">Merkle Airdrop Claim</h1>
    <div id="status" class="mb-4 text-sm text-gray-600">Not connected</div>
    <button id="connectBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
      Connect Wallet
    </button>
    <div id="eligibility" class="mt-4 p-4 bg-gray-100 rounded-lg hidden">
      <p>Address: <span id="userAddress" class="font-mono"></span></p>
      <p>Eligible Amount: <span id="eligibleAmount" class="font-semibold"></span></p>
    </div>
    <button id="claimBtn" class="mt-4 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition hidden">
      Claim Airdrop
    </button>
    <div id="txStatus" class="mt-4 text-sm text-gray-600"></div>
  </div>

  <script>
    // =============== Configuration ===============
    const CONTRACT_ADDRESS = "0x9569ad4B353D4811064ad9970B198fcb914428D5";
    const PROOFS_URL = '/proofs.json';
    const CSV_URL = '/airdrop.csv';
    const CHAIN_ID = 10143;
    const RPC_URL = 'https://testnet-rpc.monad.xyz/';

    // State
    let provider, signer, userAddress;
    let airdropData = [];

    // UI
    const statusDiv = document.getElementById('status');
    const connectBtn = document.getElementById('connectBtn');
    const eligibilityDiv = document.getElementById('eligibility');
    const userAddressSpan = document.getElementById('userAddress');
    const eligibleAmountSpan = document.getElementById('eligibleAmount');
    const claimBtn = document.getElementById('claimBtn');
    const txStatusDiv = document.getElementById('txStatus');

    // ===== Connect Wallet & Network =====
    connectBtn.addEventListener('click', async () => {
      try {
        statusDiv.textContent = 'Connecting...';
        const wcProvider = new WalletConnectProvider.default({
          rpc: { [CHAIN_ID]: RPC_URL },
          chainId: CHAIN_ID
        });
        await wcProvider.enable();
        provider = new ethers.providers.Web3Provider(wcProvider);
        signer = provider.getSigner();

        // Ensure correct network
        const network = await provider.getNetwork();
        if (network.chainId !== CHAIN_ID) {
          statusDiv.textContent = `Please switch network to Monad Testnet (chainId ${CHAIN_ID}).`;
          return;
        }

        userAddress = await signer.getAddress();
        statusDiv.innerHTML = `Connected <a href=\"https://testnet.monadscan.com/address/${userAddress}\" target=\"_blank\" class=\"text-blue-600 underline\">${userAddress}</a>`;
        connectBtn.disabled = true;
        userAddressSpan.textContent = userAddress;

        // Load CSV data
        await loadCsv();
        checkEligibility();
      } catch (err) {
        console.error(err);
        statusDiv.textContent = 'Connection failed: ' + err.message;
      }
    });

    // ===== Load CSV =====
    async function loadCsv() {
      statusDiv.textContent = 'Loading airdrop data...';
      try {
        const resp = await fetch(CSV_URL);
        const csvText = await resp.text();
        const results = Papa.parse(csvText, { header: true, skipEmptyLines: true, dynamicTyping: true });
        airdropData = results.data;
        statusDiv.textContent = 'Airdrop data loaded.';
      } catch (err) {
        console.error(err);
        statusDiv.textContent = 'Failed to load CSV: ' + err.message;
      }
    }

    // ===== Check Eligibility =====
    function checkEligibility() {
      const entry = airdropData.find(r => r.account.toLowerCase() === userAddress.toLowerCase());
      if (!entry) {
        statusDiv.textContent = 'Not eligible for airdrop.';
        return;
      }
      eligibleAmountSpan.textContent = entry.amount;
      eligibilityDiv.classList.remove('hidden');
      claimBtn.classList.remove('hidden');
      statusDiv.textContent = 'Eligible: ' + entry.amount;
      window.currentAirdrop = entry;
    }

    // ===== Claim =====
    claimBtn.addEventListener('click', async () => {
      txStatusDiv.textContent = 'Fetching proof...';
      try {
        const { index, account, amount } = window.currentAirdrop;
        const resp = await fetch(PROOFS_URL);
        const proofs = await resp.json();
        const proof = proofs[index];
        if (!proof) throw new Error('Proof not found');

        const contract = new ethers.Contract(CONTRACT_ADDRESS, [
          'function claim(uint256,address,uint256,bytes32[]) external'
        ], signer);

        txStatusDiv.textContent = 'Sending transaction...';
        const tx = await contract.claim(index, account, amount, proof);
        txStatusDiv.textContent = `Sent: ${tx.hash}`;
        await tx.wait();
        txStatusDiv.textContent = 'Claim successful!';
      } catch (err) {
        console.error(err);
        if (err.message.includes('Already claimed')) txStatusDiv.textContent = 'Error: Already claimed.';
        else if (err.message.includes('Invalid Merkle proof')) txStatusDiv.textContent = 'Error: Invalid proof.';
        else txStatusDiv.textContent = 'Tx failed: ' + err.message;
      }
    });

    // ===== Best Practices =====
    // - Serve CSV and proofs.json over HTTPS for integrity
    // - Validate parsed data types
    // - Use minimal RPC permissions
  </script>
</body>
</html>
